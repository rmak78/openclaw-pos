name: PR Web Preview

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'web/**'
      - '.github/workflows/pr-web-preview.yml'

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: pr-web-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  preview:
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: web

      - name: Deploy preview to GitHub Pages
        id: deployment
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        uses: actions/deploy-pages@v4
        with:
          preview: true

      - name: Comment preview details on PR
        uses: actions/github-script@v7
        continue-on-error: true
        env:
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          IS_FORK: ${{ github.event.pull_request.head.repo.full_name != github.repository }}
        with:
          script: |
            const marker = '<!-- pr-web-preview -->';
            const pageUrl = process.env.PAGE_URL;
            const runUrl = process.env.RUN_URL;
            const isFork = process.env.IS_FORK === 'true';

            const localFallback = [
              'Local fallback:',
              '',
              '```bash',
              'cd web',
              'python3 -m http.server 8080',
              '# open http://localhost:8080',
              '```',
            ].join('\n');

            const body = isFork
              ? [
                  marker,
                  '### ðŸ” Web preview',
                  '',
                  'This PR changes files under `web/**`, but automatic Pages preview is skipped for forked PRs for security reasons.',
                  '',
                  localFallback,
                  '',
                  `Workflow run: ${runUrl}`,
                ].join('\n')
              : [
                  marker,
                  '### ðŸ” Web preview',
                  '',
                  pageUrl
                    ? `âœ… Preview is available for this PR:\n${pageUrl}`
                    : 'âš ï¸ Preview URL was not produced yet. Re-run the workflow if this persists.',
                  '',
                  localFallback,
                  '',
                  `Workflow run: ${runUrl}`,
                ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100,
            });

            const existing = comments.find(
              (c) => c.user.type === 'Bot' && c.body && c.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
